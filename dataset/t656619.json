[
    {
        "role": "user",
        "message": "Pozdravljeni,  končno sem si uspel urediti vse potrebno, da bi lahko začel programirati sistem za pošiljanje Eračunov direktno na UJP preko njihovega B2B servisa (da ne gre preko spletne banke ampak direktno na UJP). trenutno imam opravljeno registracijo na betaeracuni portalu ki je testno okolje za te zadeve.  Od UJP sem prejel tehnično dokumentacijo in ko sem začel kodirat (delam v PHP) sem uspešno vzpostavil povezavo (getFunctions() mi vrne seznam funkcij ok), Login metoda tudi dela, Logout tudi (ti dve metodi imata argumente tipa string kar je lepo, jasno, nedvoumno napisano). Zatakne se mi pa recimo pri metodi sendInvoice, ker ima argument tipa Invoice ... tega tipa PHP sam po sebi nima, in tudi v dokumentaciji je zadeva zapisana tako, da bi lahko bila XML dokument, class z subclasi, asociativni array ali kakšna od kombinacij... Ko sem na UJP pisal mail in jih klical z vprašanjem kaj je ta tip \"Invoice\" noben, ki sem ga dobil na telefon sploh ni razumel kaj jih sploh sprašujem...  Zato me zanima ali je slučajno kdo tukaj, ki pozna zadevo ali je kdaj uspešno to implementiral in bi me bil sposoben/pripravljen obrniti v pravo smer :) Spodaj prilagam izrezek iz dokumentacije za metodo sendInvoice (če bi kdo želel celotno datoteko naj mi javi pa pošljem cel pdf.  Metoda: InvoiceStatus SendInvoice (Invoice invoice)\n\nOpis: Posiljanje e-racuna v sistem UJPeracun. E-racun mora biti sestavljen iz ovojnice (format definira zbirni center ICL; Bankart) in prilog. Prva priloga je vedno podpisan e-racun v formatu e-SLOG 1.5 ali 1.6. Ostale priloge so lahko poljubne datoteke (primer: PDF datoteka za vizualizacijo e-racuna).\nV primeru sistemske napake, napake v strukturi podatkov ali nezadostnih pravic, storitev vrne Exception. V ostalih primerih pa storitev vrne sporocilo InvoiceStatus (vec o tem v nadaljevanju).\n\nVhodni parametri:\n\nInvoice... sporocilo, ki vsebuje podatke o poslanem e-racunu. Struktura:\no Header...glavasporoc&#780;ila,kivsebuje:\n SessionId (niz do 50 znakov, obvezen)... enolicni identifikator seje\npridobljen ob klicu metode Login.\n SenderId (niz do 50 znakov, obvezen)... identifikator posiljatelja. Trenutno ni v uporabi.\n ReceiverId (niz do 50 znakov, obvezen)... identifikator prejemnika. Trenutno ni v uporabi.\no Body...telosporocila,kivsebuje:\n Envelope (ovojnica, obvezno)... ovojnica se shrani v strukturo tipa\nAttachment, ki vsebuje:\n Content (base64Binary, obvezno)... vsebina ovojnice\n FileName (niz dolz&#780;ine 50 znakov, obvezno)... ime datoteke\n Attachments (seznam prilog, obvezna vsaj ena priloga). Vsaka priloga se shrani v strukturo tipa Attachment, ki vsebuje:\n Content (base64Binary, obvezno)... vsebina priloge\n FileName (niz dolzine 50 znakov, obvezno)... ime datoteke"
    },
    {
        "role": "assistant_0",
        "message": "B2B je WebService in zanj imas WSDL. Glede na to da si na PHP, ti bo singleWsdl bolj prirocen. https://ujpnet.gov.si/B2B/Service.svc?s...  http://stackoverflow.com/questions/8989... Pojma nimam kako se ostalo naredi v PHP, ampak v .Net generiras iz WSDL class, ki ga potem uporabljas v kodi. Elektronski podpis in podobne zadeve v PHP so verjetno science fiction, tako da ti iskreno priporocam .net ali javo, ce hoces priti cez.  Navodila si verjetno nasel: http://www.ujp.gov.si/DocDir/e-racuni/V...  Drugace pa poklici na Mojdenar IT d.o.o."
    },
    {
        "role": "user",
        "message": "@assistant_0 je 23. okt 2015 ob 14:29 izjavil: Elektronski podpis in podobne zadeve v PHP so verjetno science fiction, tako da ti iskreno priporocam .net ali javo, ce hoces priti cez.  Navodila si verjetno nasel: http://www.ujp.gov.si/DocDir/e-racuni/V...  Drugace pa poklici na Mojdenar IT d.o.o.   Elektronski podpis ni noben science fiction. Ne bom rekel da nevem kako obvladam, ampak s podpisovanjem sem se pa zadnje čase veliko ukvarjal in sem za podpisovanje s PHP že kar spreten :-) tako da imam to že narejeno in dela (vsaj za račune, i jih uvažam preko spletne banke, kadar jih banka sama ne podpiše pri uvozu)  Navodila sem našel ampak se mi zdijo malo glupo napisana... sicer pa sem zdaj že precej dlje :-) - ni še fertik vse ampak se je pa malo premaknilo naprej.  hvala za namig o Mojdenar IT podpori."
    },
    {
        "role": "user",
        "message": "Ok zadevo sem spravil tako daleč, da pride sporočilo gor in da dobim odgovor... To pomeni, da se lahko začnem ukvarjat z vsebino poslanega sporočila. Odgovor, ki ga dobim je \"Ne najdem priloge RACN_00303_2015.xml znotraj ZIP datoteke!\"  Racun je navadna xml datoteka, preberem jo z file_get_contents in jo z base64_encode() zakodiram, preden jo pripnem requestu. Se komu sanja kje bi lahko bil problem? poskusil sem že dodati gzencode() in gzcompress() preden jo base64-encodam ampak je error bil še vedno isti... zdaj sem pa malo brez idej. Ima kdo drug kakšno?"
    },
    {
        "role": "assistant_1",
        "message": "XML datoteko stisni v ZIP in pošlji ZIP?"
    },
    {
        "role": "user",
        "message": "Sem razrešil... v bistvu ni bil problem v zipanju ampak sem eno pripono mel napačno pri eni od datotek.  Zdaj laufa :) hvala za pomoč"
    },
    {
        "role": "assistant_2",
        "message": "Pozdravljeni, Nujno rabim vašo informacijo/podatek.. Glede UJP E-računa.  1. Je imel že kdo vas izkušnjo s tem, da si je zablokiral račun na UJP-u ? Možen je 5x vnos gesla, da ti ga zablokirajo. Zanima me, če je to obnavljajoče se obdobje za 5x narobno vnešeno geslo? Namreč, po odblokaciji sem si ga ponovono aktivirala- tako da sem klicala na Javno upravo, dala vlogo itd,... sedaj pa sem nekajkrat ponovno vpisala narobno geslo(ne še 5x)in me skrbi, ali je to mišljeno 5x nasploh v celotnem odbodju ko ima e račun? Ali 5x v 1 dnevu, tako kot je to na bankomatu recimo.. :) 2. JE IMEL ŽE KDO IZKUŠNJO, ko si je zablokiral zadevo in so mu kasneje to aktivirali nazaj in uredili, da so kasneje to dokumentacijo poslali še po pošti?? Kako je s tem? Ali je to samo to, ko pošlješ po mailu, ti uredijo,.. nič ne pošiljajo po pošti da si kaj koli spreminjal? to me namreč zanima.  RES NAPROŠAM ZA POMOČ! Hvala že vnaprej.."
    },
    {
        "role": "assistant_3",
        "message": "Pozdravljeni,  Pravkar poskušam integrirati enak B2B vmesnik za ponudnika e-poti.  Imam težave, kako se s SoapClient($singleWsdlUri) povezati na betaeracuni.ujp.  Svoj osebni certifikat s katerim se lahko prijavim (Lokalna prijava) v UJP portal imam v oblikah P12 in PFX.  Našel sem kako pretvoriti ves PFX certifikat v private in public key na naslednji način:  $ openssl pkcs12 -in @assistant_3.pfx -nocerts -nodes -out @assistant_3.key\n$ openssl rsa -in @assistant_3.key -out @assistant_3_private.key\n$ openssl rsa -in @assistant_3.key -pubout -out @assistant_3_public.key\n$ openssl pkcs8 -topk8 -inform PEM -in @assistant_3_private.key -outform PEM -nocrypt\n Tukaj output kopiram in ustvarim novo datoteko  @assistant_3_private_pkcs8.key v katero to prilepim in jo shranim.  V test.php najprej nastavim osnovne vrednosti:  $serviceUri = \"https://betaeracuni.ujp.gov.si/b2b/service.svc\";\n$singleWsdl = \"{$serviceUri}?singlewsdl\";\n$localCert  = \"@assistant_3_public.key\";\n$localKey   = \"@assistant_3_private_pkcs8.key\";\n  Potem se poskušam povezati na različne načine: 1.  $soapClient = new \\SoapClient($singleWsdl);\n 2.  $soapClient = new \\SoapClient($singleWsdl, [\n    'local_cert' => $localCert,\n    'passphrase' => '',\n]);\n 3.  $context = stream_context_create([\n    \"ssl\" => [\n        \"local_cert\" => $localCert,\n        \"local_pk\"   => $localKey,\n    ]\n]);\n\n$soapClient = new \\SoapClient($singleWsdl, [\"context\" => $context]);\n 4.  $opts = [\n    'ssl' => [\n        'ciphers' => 'RC4-SHA',\n        'verify_peer' => false,\n        'verify_peer_name' => false,\n    ]\n];\n// SOAP 1.2 client\n$params = [\n    'encoding' => 'UTF-8',\n    'verifypeer' => false,\n    'verifyhost' => false,\n    'soap_version' => SOAP_1_1,\n    'trace' => 1,\n    'exceptions' => 1,\n    \"connection_timeout\" => 180,\n    'stream_context' => stream_context_create($opts),\n    'local_cert' => $localCert,\n    'passphrase' => '',\n];\n\n$soapClient = new \\SoapClient($singleWsdl, $params);\n 5.  $soapClient = new \\SoapClient($singleWsdl, [\n    'soap_version' => 'SOAP_1_2',\n    'location' => $serviceUri,\n    'local_cert' => $localCert,\n]);\n 6.  $contextOptions = [\n    'ssl' => [\n        'local_cert' => $localCert,\n        'local_pk' =>  $localKey,\n        'SNI_enabled' => true,\n        'peer_name' => $wsdl,\n    ]\n];\n\n$options = [\n    \"soap_version\" => SOAP_1_2,\n    \"features\" => SOAP_SINGLE_ELEMENT_ARRAYS,\n    \"stream_context\" => stream_context_create($contextOptions),\n];\n\n$soapClient = new \\SoapClient($singleWsdl, $options);\n  Brez izjeme mi vsi vrnejo enak Fatal Error:  SoapFault exception: [WSDL] SOAP-ERROR: Parsing WSDL: Couldn't load from 'https://betaeracuni.ujp.gov.si/b2b/service.svc?singlewsdl' : failed to load external entity \"https://betaeracuni.ujp.gov.si/b2b/service.svc?singlewsdl\" in C:\\laragon\\www\\ujp\\private\\test.php:27 Stack trace: #0 C:\\laragon\\www\\ujp\\private\\test.php(27): SoapClient->__construct('https://betaera...') #1 {main}\n  Predvsem se obračam na @user, ampak je dobrodošla pomoč od vsakogar, ki ima idejo, kako pomagati.  Hvala."
    },
    {
        "role": "assistant_3",
        "message": "V kolikor pa je možno dobiti vso kodo za integracijo vmesnika pa bom še bolj vesel :)"
    },
    {
        "role": "assistant_3",
        "message": "Vprašanje dodano tudi na SO: /65844882/how-to-create-certificate-to-connect-with-soap-client-with-php"
    },
    {
        "role": "assistant_4",
        "message": "Zakaj imas za SSL sifro nastavljeno RC4-SHA? To je anticno sifriranje ki ga zlomi vsak kdor hoce in verjetno UJP ne pusti takega cipher suita."
    },
    {
        "role": "assistant_3",
        "message": "@assistant_4 je 22. jan 2021 ob 14:23 izjavil:Zakaj imas za SSL sifro nastavljeno RC4-SHA? To je anticno sifriranje ki ga zlomi vsak kdor hoce in verjetno UJP ne pusti takega cipher suita.  Ker sem kopiral mnogo različnih načinov zbranih po internetu. Ta RC4-SHA kodiranje se uporabi samo v enem od šestih primerov. Katero kodiranje bi moral izbrati, da bi potem vsaj ta primer delal?"
    },
    {
        "role": "assistant_4",
        "message": "Jst tega ne vem na pamet, povez se na endpoint s kakim openssl pa poglej katere so dovoljene sifre. Kakor vem imajo zdej da mora bit protokol minimalno TLS v1.2. Ce se jst povezem pa mu pustim da izbere cipher, potem je ECDHE-RSA-AES256-SHA384"
    },
    {
        "role": "assistant_3",
        "message": "Mi je le uspelo pa si bom sam odgovoril, da prihranim čas še komu...  GitBash (ali CMD, ...)  $ cd certificate/folder\n$ openssl pkcs12 -in osebno_potrdilo.pfx -out javni_kljuc.pem -clcerts\n  PHP  <?php\n\n$serviceUri = \"https://betaeracuni.ujp.gov.si/b2b/service.svc\";\n$singleWsdl = \"{$serviceUri}?singlewsdl\";\n\n/* Certificate creation:\n    openssl pkcs12 -in osebno_potrdilo.pfx -out javni_kljuc.pem -clcerts\n        here you have to type your password once, and then the new password twice (set+confirm)\n        make sure the new password is different than your password, since everybody with access to code will see it.\n */\n$params = [\n    'local_cert' => 'javni_kljuc.pem',\n    'passphrase' => \"new_password\", // change accordingly\n    'trace' => 1,\n    'exceptions' => 0\n];\n\n$soapClient = new \\SoapClient(\"https://betaeracuni.ujp.gov.si/b2b/service.svc?singlewsdl\", $params);\n\nvar_dump($soapClient->__getFunctions());"
    },
    {
        "role": "assistant_3",
        "message": "Argh! Problem številka 2.  Ponovno najbolj upam, da boš @user pogledal tole :)  Kot sem zgoraj napisal sem s certifikatom prišel skozi in se s SoapClient povezal na singleWsdl. Spremenil sem le options parameter ` 'exceptions' => true `, da ne rabim za vsak response preverjat ` if (get_class($response) === 'SoapFault') throw Exception($response); `. Brez težav dobim tudi $soapClient->__getFunctions(); in $soapClient->__getTypes();  Prva funkcija (metoda), ki jo moram uporabit je seveda ` $soapClient->Login(string password); `. Ampak kako?  Najprej sem seveda probal tako:   $soapClient->Login('moje-ujp-geslo');\n  Po neuspešnem poskusu ugotovim, da obstaja \\SoapParam, in sem probal še:   $soapClient->Login(new \\SoapParam('moje-ujp-geslo', 'password'));\n  V obeh primerih se v brskalniku izpiše Fatal error:   Fatal error: Uncaught SoapFault exception: [s:Client] Atribut <password> je obvezen. in C:\\laragon\\www\\ujp\\private\\test.php:63 Stack trace: #0 C:\\laragon\\www\\ujp\\private\\test.php(63): SoapClient->__call('Login', Array) #1 {main} thrown in C:\\laragon\\www\\ujp\\private\\test.php on line 63\n  Kako pravilno podati parametre? Rubber duck :)   $soapClient->Login([\n    'password' => 'moje-ujp-geslo',\n]);"
    }
]