[
    {
        "role": "user",
        "message": "E-račun se pošilja preko spletne banke, kjer ni potrebna prijava s certifikatom. Vsa testiranja so bila OK, pri pravih računih pa pride do zavrnitve, ker v XML kodi ni elektronskega podpisa. Kako bi elektronski podpis vstavil v XML kodo (primer)?  Lahko kdo pomaga?"
    },
    {
        "role": "assistant_0",
        "message": "S čem pa generiraš tisti XML račun? Načeloma bi moralo že to orodje vstaviti elektronski podpis, tako da zadevo samo še importiraš na banki."
    },
    {
        "role": "user",
        "message": "Naredi ga koda v mojem programu - vrstico za vrstico. To deluje, manjka samo podpis. Če bi oddajali preko UJP portala, se baje to doda samo, nisem še preizkusil na kakšnem Prokliku, ki za prijavo potrebuje certifikat. Pri Banki Koper se prijaviš samo s čitalcem in kartico in datoteka se ne podpiše sama od sebe. Ali drugače povedano: Moj program naredi zip datoteko, ki vsebuje XML račun, ovojnico in PDF račun. Zadeva nima napak po shemi ali vsebini. Ko to elektronsko podpisati? Do danes sem mislil, da to naredi banka, ko datoteko oddaš."
    },
    {
        "role": "assistant_1",
        "message": "Si siguren, da v sami shemi ni določeno kje ter v kakšni obliki mora biti elektronski podpis? Če si tak dober, prlimi še link do sheme XML-ja (če-le imaš te pravice). Mogoče še kašen DTD tudi zraven? Ker fora je, da osebno ne poznam protokola, je pa 100% določen iz strani bank (po možnosti celo berljiv)."
    },
    {
        "role": "assistant_2",
        "message": "Malo več boš moral povedat v kerem programskem jeziku maš spisan program. Par primerov za XMLDSIG podpise: C# (link, link), Java, C/C++ (XmlSec). Drugače pa tko kot je reku @assistant_0, program ki zgenerira xml bi mogu met funkcijo za podpis."
    },
    {
        "role": "user",
        "message": "Clarion. Kakšnih funkcij za podpis ni. Sploh ni kakšne hude podpore za XML, zato ga pišem kot tekstovno datoteko vrstico za vrstico. Za elektronski podpis pa mi je zmanjkalo idej."
    },
    {
        "role": "assistant_3",
        "message": "@assistant_2 je 14. jan 2015 ob 14:45 izjavil:Malo več boš moral povedat v kerem programskem jeziku maš spisan program. Par primerov za XMLDSIG podpise: C# (link, link), Java, C/C++ (XmlSec). Drugače pa tko kot je reku @assistant_0, program ki zgenerira xml bi mogu met funkcijo za podpis.   Imaš prav. E-račun kakor vem je podpisan po XML signature standardu:  http://www.w3.org/TR/xmldsig-core/"
    },
    {
        "role": "user",
        "message": "Shema za cel eračun je v priročniku: http://www.gzs.si/slo/28209 (priročnik - dopolnjena dokumentacija: točka 4 (str. 20): Digitalni podpis e-računa). Tukaj je nekaj napisano, ampak jaz se iz tega ne znajdem.    @assistant_1 je 14. jan 2015 ob 14:44 izjavil:Si siguren, da v sami shemi ni določeno kje ter v kakšni obliki mora biti elektronski podpis? Če si tak dober, prlimi še link do sheme XML-ja (če-le imaš te pravice). Mogoče še kašen DTD tudi zraven? Ker fora je, da osebno ne poznam protokola, je pa 100% določen iz strani bank (po možnosti celo berljiv)."
    },
    {
        "role": "assistant_4",
        "message": "Naredit moras xmldsig. So ljudje ze dal primere."
    },
    {
        "role": "assistant_2",
        "message": "@user je 14. jan 2015 ob 14:48 izjavil:Clarion. Kakšnih funkcij za podpis ni. Sploh ni kakšne hude podpore za XML, zato ga pišem kot tekstovno datoteko vrstico za vrstico. Za elektronski podpis pa mi je zmanjkalo idej.  Žal nimam pojma o Clarionu. Če imaš varjanto probaj z Clarion.NET, s tem bi dobil možnost uporabe .NET funkcijonalnosti za XMLDSIG. Tu si lahko pogledaš en primer klienta, ki pošilja podpisane SOAP message na webservis."
    },
    {
        "role": "assistant_5",
        "message": "Ali iz Clariona lahko kličeš COM objektov, torej pripraviš podpisovanje v kakšnem drugem okolju in zadevo integriraš.  Sam sem že nekaj časa pripravil eno knjižnjico namensko za podpis e-računov, ki se lahko uporablja preko COM-a ali pa direktno kot .NET knjižnjico, no možno bi jo bilo klicati tudi preko command-line interface-ja. V kolikor te zanima mi sporoči preko ZS."
    },
    {
        "role": "assistant_6",
        "message": "@assistant_3 je 14. jan 2015 ob 14:50 izjavil:@assistant_2 je 14. jan 2015 ob 14:45 izjavil:Malo več boš moral povedat v kerem programskem jeziku maš spisan program. Par primerov za XMLDSIG podpise: C# (link, link), Java, C/C++ (XmlSec). Drugače pa tko kot je reku @assistant_0, program ki zgenerira xml bi mogu met funkcijo za podpis.   Imaš prav. E-račun kakor vem je podpisan po XML signature standardu:  http://www.w3.org/TR/xmldsig-core/   Vsi eRačuni, ki se pošiljajo na UJP moraji biti digitalno podpisani.  S tem, da Slovenci ne bi bili Slovenci, če zgoraj omenjenega standarda ne bi priredili po svoje! Shema, po kateri se preverja digitalni podpis je namreč prirejena tako, da ne omogoča značke  <Transforms> ki jo zgoraj omenjeni standard seveda omogoča. V dokumentaciji je značka prisotna in razložen njen pomen v sami shemi pa je značka odtranjena.  Tudi ICL ovojnica bi naj bila samo ena - bi naj bila, ker banke so si to spet priredile po svoje.  Ta naš eRačun je ena velika zmešnjava in skrpucalo..."
    },
    {
        "role": "assistant_7",
        "message": "Pozdravljeni, sem nov uporabnik tegale portala, ker nikjer drugje na internetu nisem našel uporabne dokumentacije...  zanima me torej sledeče: Je kdo uspel pripraviti program, ki generira veljaven elektronski podpis za Eračun, ki se ujema po shemi, ki jo zahteva portal UJPnet?  ker jaz se že kak mesec ukvarjam z zadevo, pripravil sem ogro@assistant_3o podpisov, ki so bili po vseh možnih standardih in shemah veljavni, ko pa sem jih naložil v testno okolje na portalu UJPnet, sem pa dobil odgovor, da je dokument neveljaven...  100% se strnjam s tem kar pravi @assistant_6, da so poponoma brezveze zakomplicirali shemo in s tem v bistvu onemogočili uporabo katerekoli generične knjižnice za generiranje Xades podpisa... (mimogrede, podpis, ki ga zahtevajo je (vsaj približno) XADES-BES. XMLDSIG ni dovolj.)  Če je omenjen podvig komurkoli uspel in bi bil pripravljen deliti svojo programsko kodo, bi mu bil neznansko hvaležen.  Lep pozdrav vsem"
    },
    {
        "role": "assistant_4",
        "message": "Kolikor jst vem je navaden XMLDSIG, dat ga moras pa v taprav element (Signatures)."
    },
    {
        "role": "assistant_7",
        "message": "navaden XMLDSig ni dovolj. Shema predvideva tudi značko  <object>, ki vsebuje komponente XADES podpisa (ampak ker je to slovenska javna uprava seveda ne vsebuje vseh standardnih komponent XADES...) :)"
    },
    {
        "role": "assistant_8",
        "message": "Sicer je že več kot eno leto, pa vendar:  UJP sprejme eRačun, ki je podpisan z navadnim XMLDSIG - enveloped (imeti mora tudi element  <Transforms><Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\" /></Transforms> ) Sedaj pa se je pri nas prvič pojavila situacija, ko \"gre\" eRačun izven sistema UJP na eno izmed bank. Ta banka pa seveda preverja xml tudi glede na eSlog shemo in gladko zarne račun. (pač da, tako kot je napisal MD_DS potreben je XaDES podpis).  Sedaj pa problem. V Visual Studiu mi tega nikakor ne uspe sproducirat... Če je slučajno komu uspelo, bi bil zelo hvaležen za kakšen namig oz. primer."
    },
    {
        "role": "assistant_9",
        "message": "public static string Podpisi(X509Certificate2 cert, string xml)\n{\n    XmlDocument xmlDoc = new XmlDocument();\n    xmlDoc.PreserveWhitespace = false;\n    xmlDoc.LoadXml(xml);\n \n    var signedXml = new SignedXml(xmlDoc);\n    signedXml.Signature.Id = \"SignatureId\";\n \n    signedXml.SignedInfo.CanonicalizationMethod = \"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\";\n    signedXml.SignedInfo.SignatureMethod = \"http://www.w3.org/2000/09/xmldsig#rsa-sha1\";\n \n    Reference reference = new Reference();\n    reference.Type = \"http://www.gzs.si/shemas/eslog/racun/1.5#Racun\";\n    reference.Uri = \"#data\";\n    reference.DigestMethod = \"http://www.w3.org/2000/09/xmldsig#sha1\";\n    signedXml.AddReference(reference);\n \n    signedXml.SigningKey = cert.PrivateKey;\n    KeyInfo keyInfo = new KeyInfo();\n    KeyInfoX509Data keyInfoX509Data = new KeyInfoX509Data(cert, X509IncludeOption.ExcludeRoot);\n    keyInfo.AddClause(keyInfoX509Data);\n    signedXml.KeyInfo = keyInfo;\n \n    string URI = \"http://uri.etsi.org/01903/v1.1.1#\";\n \n    var qualifyingPropertiesNode = xmlDoc.CreateElement(\"xds\", \"QualifyingProperties\", URI);\n    qualifyingPropertiesNode.SetAttribute(\"Target\", \"#SignatureId\");\n \n    var signedPropertiesNode = xmlDoc.CreateElement(\"xds\", \"SignedProperties\", URI);\n    signedPropertiesNode.SetAttribute(\"Id\", \"SignedPropertiesId\");\n \n    var signedSignaturePropertiesNode = xmlDoc.CreateElement(\"xds\", \"SignedSignatureProperties\", URI);\n \n    var signingTimeNode = xmlDoc.CreateElement(\"xds\", \"SigningTime\", URI);\n    signingTimeNode.InnerText = DateTime.Now.ToString(\"yyyy-MM-ddTHH:mm:ss.fffZ\"); //2011-09-05T09:11:24.268Z\n    signedSignaturePropertiesNode.AppendChild(signingTimeNode);\n \n    SHA1 cryptoServiceProvider = new SHA1CryptoServiceProvider();\n    byte[] sha1 = cryptoServiceProvider.ComputeHash(cert.RawData);\n \n    var signingCertificateNode = xmlDoc.CreateElement(\"xds\", \"SigningCertificate\", URI);\n    var certNode = xmlDoc.CreateElement(\"xds\", \"Cert\", URI);\n    var certDigestNode = xmlDoc.CreateElement(\"xds\", \"CertDigest\", URI);\n    var digestMethodNode = xmlDoc.CreateElement(\"xds\", \"DigestMethod\", URI);\n    digestMethodNode.SetAttribute(\"Algorithm\", SignedXml.XmlDsigSHA1Url);\n    var digestValueNode = xmlDoc.CreateElement(\"xds\", \"DigestValue\", URI);\n    digestValueNode.InnerText = Convert.ToBase64String(sha1);\n    certDigestNode.AppendChild(digestMethodNode);\n    certDigestNode.AppendChild(digestValueNode);\n    certNode.AppendChild(certDigestNode);\n \n    var issuerSerialNode = xmlDoc.CreateElement(\"xds\", \"IssuerSerial\", URI);\n    var x509IssuerNameNode = xmlDoc.CreateElement(\"ds\", \"X509IssuerName\", \"http://www.w3.org/2000/09/xmldsig#\");\n    x509IssuerNameNode.InnerText = cert.IssuerName.Name;\n    var x509SerialNumberNode = xmlDoc.CreateElement(\"ds\", \"X509SerialNumber\", \"http://www.w3.org/2000/09/xmldsig#\");\n \n    x509SerialNumberNode.InnerText = Convert.ToInt32(cert.SerialNumber, 16).ToString();\n    issuerSerialNode.AppendChild(x509IssuerNameNode);\n    issuerSerialNode.AppendChild(x509SerialNumberNode);\n    certNode.AppendChild(issuerSerialNode);\n \n    signingCertificateNode.AppendChild(certNode);\n \n    var signaturePolicyIdentifierNode = xmlDoc.CreateElement(\"xds\", \"SignaturePolicyIdentifier\", URI);\n    var signaturePolicyImpliedNode = xmlDoc.CreateElement(\"xds\", \"SignaturePolicyImplied\", URI);\n    signaturePolicyIdentifierNode.AppendChild(signaturePolicyImpliedNode);\n \n    signedSignaturePropertiesNode.AppendChild(signingCertificateNode);\n    signedSignaturePropertiesNode.AppendChild(signaturePolicyIdentifierNode);\n \n    signedPropertiesNode.AppendChild(signedSignaturePropertiesNode);\n    qualifyingPropertiesNode.AppendChild(signedPropertiesNode);\n \n    var dataObject = new DataObject();\n    dataObject.Data = qualifyingPropertiesNode.SelectNodes(\".\");\n    signedXml.AddObject(dataObject);\n \n    signedXml.ComputeSignature();\n \n    XmlElement xmlDigitalSignature = signedXml.GetXml();\n    xmlDoc.DocumentElement.AppendChild(xmlDoc.ImportNode(xmlDigitalSignature, true));\n \n    if (!signedXml.CheckSignature())\n    {\n        throw new Exception(\"Digitalni podpis eRačuna ni veljaven!\");\n    }\n \n    return xmlDoc.OuterXml;\n}"
    },
    {
        "role": "assistant_10",
        "message": "Na GitHub-u imaš knjižnico: MPrtenjak/MNetESlog"
    },
    {
        "role": "assistant_11",
        "message": "A obstaja kakšna odprtokodna XSLT datoteka za vizualizacijo e-računa - verzija 1.6, 1.61 (iz xml v html)? Kakšen link?"
    },
    {
        "role": "assistant_9",
        "message": "Kaj pa če vprašaš SETCCE za soglasje?  https://www.gzs.si/e-poslovanje/dokumen..."
    },
    {
        "role": "assistant_11",
        "message": "A je to kdo poizkusil? Kakšen je bil odgovor?"
    },
    {
        "role": "assistant_12",
        "message": "Ima mogoče kdo kodo za podpis xml-a e računa v PHP?"
    }
]