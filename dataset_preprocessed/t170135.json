[
    {
        "role": "user",
        "message": "Torej, problem je naslednji.  Imam neke JPEG in PDF datoteke, za katere bi rad, da so dostopne samo z geslom.  Datoteke sem zato spravil na disk izven /www direktorija, torej niso neposredno dostopne (v vpisom URLja v brskalnik).  Imam index.php datoteko, kjer preverim geslo, potem pa prikažem seznam - linke do datotek. Linki pa so oblikovani v naslednji obliki:  a href=\"file.php/?ime_fajla.pdf\"  Ko kliknem gor, mi skripta file.php preveri avtentikacijo (zaenkrat imam narejeno samo glede na http referer - bom sprogramiral s session cookijem, ko bo ostalo delalo) in če je avtentikacija OK, naj bi skripta poslala ustrezne headerje in datoteko, ki jo prebere iz diska.  Now, the problem.  Na Zendu sem našel skriptico, ki naj bi storila točno to. Pravzaprav naj bi poslala headerje, ki bi omogočili forcible download, da torej brskalnik datoteko downloada in ne odpre. Te ukaze sem dal v komentar.  Vendar. Zadeva v FireFoxu lepo dela. V MSIE pa se usuje. In ko se usuje v MSIE, ne dela več tudi v FF. Usuje se pa tako, da datoteke sploh ne prikaže, pač pa prikaže ... v bistvu nič. Tudi reload ne pomaga. Vendar to ne velja za vse datoteke - nekatere MSIE lepo prikaže, drugih pa ne. Včasih eno prikaže, v drugem sessionu pa jo ne prikaže več.  A morda kdo ve v čem je trik? Verjetno pošiljam kakšen header narobe, kakšna prav banalna napaka mora biti. Skripta file.php je tule spodaj:   <php\n$errormsg = \"Dostop do te datoteke ni mogoč brez gesla.\";\n\n$wtreferer = addslashes($HTTP_REFERER);\n\n// This is a foo authentication method. Session cookies should be used instead.\nif (($wtreferer == \"http://***/index.php\") || ($wtreferer == \"http://***/\")) {\n  if ($QUERY_STRING==\"\") {\n    echo \"Nedovoljen poiskus dostopa!\";\n  }\n  else {\n    dl_file($QUERY_STRING);\n  }\n}\nelse {\n  echo \"$errormsg\";\n}\n\n\nfunction dl_file($file){\n   // open file from the secret location\n   $file = \"/home/*******/\".$file;\n\n   //First, see if the file exists\n   if (!is_file($file)) { die(\"$errormsg\"); }\n\n   //Gather relevent info about file\n   $len = filesize($file);\n   $filename = basename($file);\n   $file_extension = strtolower(substr(strrchr($filename,\".\"),1));\n\n   //This will set the Content-Type to the appropriate setting for the file\n   switch( $file_extension ) {\n     case \"pdf\": $ctype=\"application/pdf\"; break;\n     case \"exe\": $ctype=\"application/octet-stream\"; break;\n     case \"zip\": $ctype=\"application/zip\"; break;\n     case \"doc\": $ctype=\"application/msword\"; break;\n     case \"xls\": $ctype=\"application/vnd.ms-excel\"; break;\n     case \"ppt\": $ctype=\"application/vnd.ms-powerpoint\"; break;\n     case \"gif\": $ctype=\"image/gif\"; break;\n     case \"png\": $ctype=\"image/png\"; break;\n     case \"jpeg\": $ctype=\"image/jpg\"; break;\n     case \"jpg\": $ctype=\"image/jpg\"; break;\n     case \"mp3\": $ctype=\"audio/mpeg\"; break;\n     case \"wav\": $ctype=\"audio/x-wav\"; break;\n     case \"mpeg\": $ctype=\"video/mpeg\"; break;\n     case \"mpg\": $ctype=\"video/mpeg\"; break;\n     case \"mpe\": $ctype=\"video/mpeg\"; break;\n     case \"mov\": $ctype=\"video/quicktime\"; break;\n     case \"avi\": $ctype=\"video/x-msvideo\"; break;\n\n     //The following are for extensions that shouldnt be downloaded (sensitive stuff, like php files)\n     case \"php\":\n     case \"htm\":\n     case \"html\":\n     case \"txt\": die(\"$errormsg\"); break;\n\n     //default: $ctype=\"application/force-download\";\n   }\n\n   //Begin writing headers\n   //header(\"Pragma: public\");\n   //header(\"Expires: 0\");\n   //header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n   //header(\"Cache-Control: public\");\n   //header(\"Content-Description: File Transfer\");\n\n   //Use the switch-generated Content-Type\n   header(\"Content-Type: $ctype\");\n\n   //Force the download\n   //$header=\"Content-Disposition: attachment; filename=\".$filename.\";\";\n   header($header );\n   //header(\"Content-Transfer-Encoding: binary\");\n   header(\"Content-Length: \".$len);\n   @readfile($file);\n   exit;\n}\n\n?>  Torej, kje pri headerjih ga polomim?"
    },
    {
        "role": "assistant_0",
        "message": "zivjo!  jaz sem imel podobne probleme in zaenkrat mi taksna kombinacija deluje normalno:  \theader ('Pragma: public');\n\theader ('Cache-Control: must-revalidate, post-check=0, pre-check=0');\n\theader ('Content-Type: application/save');\n\theader ('Content-Disposition: attachment; filename=\"' . $name . '\"');\n\theader ('Content-Length: ' . $size);\n  content type je kar nekaj zblj, kar bi naj browser prisililo, da naj zadevo downloada. tole sem preizkusil in mi je forsiralo download v operi, konquerorju, firefoxu ter ie. tudi razne pdf-je, word dokumente, etc, sem lahko normalno downloadal. aja, ce odstranim \"pragma\", potem mi preko ssl v ie download ne deluje vec. v glavnem, ker si nekateri browserji po svoje interpretirajo zadeve ali pa (delno) ignorirajo headerje, se zna zgoditi, da bos imel tezavice. upam, da ti bo to pomagalo."
    },
    {
        "role": "user",
        "message": "Hmm, jaz bi rad, da ODPRE, ne shrani. Pa niti odpreti noce (oz. vcasih ja, vcasih ne)."
    },
    {
        "role": "assistant_0",
        "message": "hmm, oprosti, sem te narobe razumel. morda lahko poskusis namesto  \theader ('Content-Disposition: attachment; filename=\"' . $name . '\"'); dat  \theader ('Content-Disposition: inline; filename=\"' . $name . '\"');? je ze dolgo, kar sem se s tem ukvarjal, tako da nisem preprican, lahko pa, da bo pomagalo."
    },
    {
        "role": "user",
        "message": "OK, zdaj sem dal takole... zadeva naj se ne bi cachirala, naj bi bil binary content in naj bi se prikazalo in ne downloadalo.  FF prikaze ok. MSIE pa... za jpeg pokaze save or open dialog, potem pa downloada in ne prikaze (ce dam open). Za PDF pa javi \"File does not begin with %PDF-\".  Koda je pa naslednja:    function dl_file($file){\n   $file = \"/home/***/\".$file;\n\n   //First, see if the file exists\n   if (!is_file($file)) { die(\"$errormsg\"); }\n\n   //Gather relevent info about file\n   $len = filesize($file);\n   $filename = basename($file);\n   $file_extension = strtolower(substr(strrchr($filename,\".\"),1));\n\n   //This will set the Content-Type to the appropriate setting for the file\n   switch( $file_extension ) {\n     case \"pdf\": $ctype=\"application/pdf\"; break;\n     case \"exe\": $ctype=\"application/octet-stream\"; break;\n     case \"zip\": $ctype=\"application/zip\"; break;\n     case \"doc\": $ctype=\"application/msword\"; break;\n     case \"xls\": $ctype=\"application/vnd.ms-excel\"; break;\n     case \"ppt\": $ctype=\"application/vnd.ms-powerpoint\"; break;\n     case \"gif\": $ctype=\"image/gif\"; break;\n     case \"png\": $ctype=\"image/png\"; break;\n     case \"jpeg\": $ctype=\"image/jpg\"; break;\n     case \"jpg\": $ctype=\"image/jpg\"; break;\n     case \"mp3\": $ctype=\"audio/mpeg\"; break;\n     case \"wav\": $ctype=\"audio/x-wav\"; break;\n     case \"mpeg\": $ctype=\"video/mpeg\"; break;\n     case \"mpg\": $ctype=\"video/mpeg\"; break;\n     case \"mpe\": $ctype=\"video/mpeg\"; break;\n     case \"mov\": $ctype=\"video/quicktime\"; break;\n     case \"avi\": $ctype=\"video/x-msvideo\"; break;\n\n     //The following are for extensions that shouldnt be downloaded (sensitive stuff, like php files)\n     case \"php\":\n     case \"htm\":\n     case \"html\":\n     case \"txt\": die(\"$errormsg\"); break;\n\n     //Force the download\n     //default: $ctype=\"application/force-download\";\n   }\n\n   //NEW HEADERZ\n   //Begin writing headers\n   // Content is never cached\n   header(\"Pragma: no-cache\");\n   header(\"Expires: -1\");\n   header(\"Cache-Control: private\");\n   header(\"Cache-Control: must-revalidate, no-cache, no-store, post-check=0, pre-check=0\");\n   // Optional header with a description\n   //header(\"Content-Description: File Transfer\");\n   //NEW HEADERZ\n\n   //OLD HEADERZ\n   //header(\"Pragma: public\");\n   //header(\"Expires: 0\");\n   //header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n   //header(\"Cache-Control: public\");\n   //header(\"Content-Description: File Transfer\");\n   //OLD HEADERZ\n\n   //Use the switch-generated Content-Type\n   header(\"Content-Type: $ctype\");\n\n   //Force the download\n   $header=\"Content-Disposition: inline; filename=\".$filename.\";\";\n   header($header );\n   header(\"Content-Transfer-Encoding: binary\");\n   header(\"Content-Length: \".$len);\n   @readfile($file);\n   exit;\n}"
    },
    {
        "role": "assistant_1",
        "message": "imam problem v phpBB forumu  sem si ga naredu in sem si tudi že nekaj v administratorskem prostoru nekaj spreminjal in sicer SLL al SSL in sedaj mi več ne dela :(  Mi zna kod pomagat?"
    },
    {
        "role": "assistant_2",
        "message": "@Matthai: IE ima velike probleme s PDFji.  header(\"Content-type: application/pdf\"); header(\"Content-Disposition: attachment; filename=report-\" . $input->func . \".pdf\"); header(\"Expires: Mon, 26 Jul 1997 05:00:00 GMT\"); header(\"Cache-Control: must-revalidate, post-check=0,pre-check=0\"); header(\"Pragma: public\");  Tole definitivno deluje tudi v IE AFAIR.  AFAIK: Content-Disposition: attachment;  mora vedno odpreti okno za shranjevanje datoeke"
    }
]